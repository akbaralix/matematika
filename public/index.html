<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <title>Matematik</title>
  </head>
  <body>
    <!-- üîπ Asosiy menyu -->
    <div id="menyu" class="menyu">
      <button onclick="boshlash()">‚ñ∂Ô∏è Boshlash</button>
      <button onclick="statistika()">üìä Statistika</button>
    </div>

    <!-- üîπ O'yin container -->
    <div id="game-container" class="game-container" style="display: none">
      <div class="container">
        <div class="control-container">
          <div class="togrijavob">‚úÖ 0</div>
          <div class="xatolar">‚ùå 0</div>
        </div>

        <div class="game-bar">
          <div class="randomnumber">
            <span id="randomnum1"></span>
          </div>
          <div class="variantlar">
            <span class="javob"></span>
            <span class="javob"></span>
            <span class="javob"></span>
          </div>

          <button
            class="qaytaBoshlash"
            onclick="qaytaBoshlash()"
            style="display: none"
          >
            Qayta boshlash
          </button>

          <div class="time-container">
            <div class="time"></div>
          </div>
        </div>

        <button class="Orqaga" onclick="location.reload()">üîô Orqaga</button>
      </div>
    </div>

    <!-- üîπ Statistika container -->
    <div class="statistika-container" style="display: none">
      <h2>Statistika</h2>
      <div class="user-statistik">
        <h3>Top foydalanuvchilar:</h3>
        <div id="ranking-list"></div>
      </div>
      <button class="Orqaga" onclick="location.reload()">üîô Orqaga</button>
    </div>

    <script>
      // üîπ Elementlar
      const randomnum1 = document.getElementById("randomnum1");
      const javoblar = document.querySelectorAll(".javob");
      const togrijavob = document.querySelector(".togrijavob");
      const xatolar = document.querySelector(".xatolar");
      let togri = 0;
      let xato = 0;
      let currentAnswer = null;
      let timer;

      // üîπ Telegram WebApp foydalanuvchi ma'lumotlari
      const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user || {};
      const TELEGRAM_USER_ID = tgUser.id || 0;
      const TELEGRAM_USER_NAME = `${tgUser.first_name || ""} ${
        tgUser.last_name || ""
      }`.trim();
      const TELEGRAM_USER_AVATAR = tgUser.photo_url || "";

      // üîπ Javobni tekshirish
      javoblar.forEach((el) => {
        el.addEventListener("click", () => {
          if (parseInt(el.textContent) === currentAnswer) {
            togri++;
            togrijavob.textContent = `‚úÖ ${togri}`;
          } else {
            xato++;
            xatolar.textContent = `‚ùå ${xato}`;
          }

          if (xato === 4) {
            gameOver();
            return;
          }

          startgame();
          startProgress();
        });
      });

      // üîπ O'yin tugadi
      async function gameOver() {
        clearTimeout(timer);
        alert(`O'yin tugadi! To'g'ri javoblar soni: ${togri}`);

        if (TELEGRAM_USER_ID) {
          try {
            await fetch("https://matematika.onrender.com/save-score", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                user_id: TELEGRAM_USER_ID,
                score: togri,
                name: TELEGRAM_USER_NAME,
                avatar: TELEGRAM_USER_AVATAR,
              }),
            });
          } catch (err) {
            console.log("‚ùå Bal saqlashda xatolik:", err);
          }
        }

        document.querySelector(".qaytaBoshlash").style.display = "flex";
      }

      // üîπ Qayta boshlash tugmasi
      function qaytaBoshlash() {
        togri = 0;
        xato = 0;
        togrijavob.textContent = `‚úÖ ${togri}`;
        xatolar.textContent = `‚ùå ${xato}`;
        document.querySelector(".qaytaBoshlash").style.display = "none";
        startgame();
        startProgress();
      }

      // üîπ Savol yaratish
      function startgame() {
        let random1 = Math.floor(Math.random() * 10);
        let random2 = Math.floor(Math.random() * 10);
        const amal = Math.random() < 0.5 ? "+" : "-";

        if (amal === "-" && random1 < random2)
          [random1, random2] = [random2, random1];

        currentAnswer = amal === "+" ? random1 + random2 : random1 - random2;
        randomnum1.textContent = `${random1} ${amal} ${random2} = ?`;

        const variantlar = [
          currentAnswer,
          currentAnswer + Math.floor(Math.random() * 3) + 1,
          currentAnswer - Math.floor(Math.random() * 3) - 1,
        ].sort(() => Math.random() - 0.5);

        javoblar.forEach((el, i) => (el.textContent = variantlar[i]));
      }

      // üîπ Progress bar va vaqt
      function startProgress() {
        const bar = document.querySelector(".time");
        clearTimeout(timer);

        bar.style.transition = "none";
        bar.style.width = "100%";

        setTimeout(() => {
          bar.style.transition = "width 5s linear";
          bar.style.width = "0%";
        }, 50);

        timer = setTimeout(() => {
          xato++;
          xatolar.textContent = `‚ùå ${xato}`;
          if (xato === 4) {
            gameOver();
            return;
          }
          startgame();
          startProgress();
        }, 5000);
      }

      // üîπ Boshlash tugmasi
      function boshlash() {
        document.getElementById("game-container").style.display = "block";
        document.getElementById("menyu").style.display = "none";
        startgame();
        startProgress();
      }

      // üîπ Statistika tugmasi
      async function statistika() {
        document.getElementById("menyu").style.display = "none";
        document.querySelector(".statistika-container").style.display = "block";
        await getRanking();
      }

      // üîπ Reytingni olish
      async function getRanking() {
        const rankingList = document.getElementById("ranking-list");
        rankingList.innerHTML = "<p>Yuklanmoqda...</p>";

        try {
          const res = await fetch(
            "https://matematika.onrender.com/get-ranking"
          );
          const data = await res.json();

          rankingList.innerHTML = "";
          let userRank = null;
          const totalUsers = data.length;

          data.forEach((user, i) => {
            const li = document.createElement("li");
            li.style.display = "flex";
            li.style.alignItems = "center";
            li.style.marginBottom = "5px";

            // avatar
            const img = document.createElement("img");
            img.src = user.avatar || "";
            img.alt = "avatar";
            img.style.width = "30px";
            img.style.height = "30px";
            img.style.borderRadius = "50%";
            img.style.marginRight = "10px";
            if (!user.avatar) img.style.display = "none";

            // foydalanuvchi ismi va username
            const nameSpan = document.createElement("span");
            nameSpan.innerHTML = `${i + 1} <b>${user.name || "NoName"}</b> ${
              user.username ? `(@${user.username})` : ""
            }`;

            // score
            const scoreSpan = document.createElement("span");
            scoreSpan.style.marginLeft = "auto";
            scoreSpan.textContent = `${user.score ?? 0} ‚úÖ`;

            li.appendChild(img);
            li.appendChild(nameSpan);
            li.appendChild(scoreSpan);

            rankingList.appendChild(li);

            if (user.user_id === TELEGRAM_USER_ID) userRank = i + 1;
          });

          // foydalanuvchi o‚Äòrnini ko‚Äòrsatish
          const userStat = document.createElement("div");
          userStat.style.marginTop = "15px";
          userStat.style.fontWeight = "bold";

          if (userRank) {
            userStat.textContent = `‚≠ê Sizning o‚Äòrningiz: ${userRank}-o‚Äòrin / ${totalUsers} ta foydalanuvchi orasida`;
          } else {
            userStat.textContent = `Siz hali reytingda yo‚Äòqsiz üò¢ O‚Äòyin o‚Äòynab ko‚Äòproq ball to‚Äòplang!`;
          }

          rankingList.parentElement.appendChild(userStat);
        } catch (err) {
          rankingList.innerHTML =
            "<p>‚ùå Reytingni olishda xatolik yuz berdi.</p>";
          console.log(err);
        }
      }
    </script>
  </body>
</html>
