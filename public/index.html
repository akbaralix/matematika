<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <title>Matematik</title>
  </head>
  <body>
    <!-- üîπ Asosiy menyu -->
    <div id="menyu" class="menyu">
      <button onclick="boshlash()">‚ñ∂Ô∏è Boshlash</button>
      <button onclick="statistika()">üìä Statistika</button>
    </div>

    <!-- üîπ O'yin container -->
    <div id="game-container" class="game-container" style="display: none">
      <div class="container">
        <div class="control-container">
          <div class="togrijavob">‚úÖ 0</div>
          <div class="xatolar">‚ùå 0</div>
        </div>

        <div class="game-bar">
          <div class="randomnumber">
            <span id="randomnum1"></span>
          </div>
          <div class="variantlar">
            <span class="javob"></span>
            <span class="javob"></span>
            <span class="javob"></span>
          </div>
          <!-- javob uchun 5s vaqt -->
          <div class="time-container">
            <div class="time"></div>
          </div>
        </div>

        <button class="Orqaga" onclick="location.reload()">üîô Orqaga</button>
      </div>
    </div>

    <!-- üîπ Statistika container -->
    <div class="statistika-container" style="display: none">
      <h2>Statistika</h2>
      <div class="user-statistik">
        <h3>Top foydalanuvchilar:</h3>
        <ol id="ranking-list"></ol>
      </div>
      <button class="Orqaga" onclick="location.reload()">üîô Orqaga</button>
    </div>

    <script>
      // üîπ Elementlar
      const randomnum1 = document.getElementById("randomnum1");
      const javoblar = document.querySelectorAll(".javob");
      const togrijavob = document.querySelector(".togrijavob");
      const xatolar = document.querySelector(".xatolar");

      let togri = 0;
      let xato = 0;
      let currentAnswer = null;

      // üîπ Telegram WebApp foydalanuvchi ma'lumotlari
      const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user || {};
      const TELEGRAM_USER_ID = tgUser.id || 0;
      const TELEGRAM_USER_NAME = `${tgUser.first_name || ""} ${
        tgUser.last_name || ""
      }`.trim();
      const TELEGRAM_USER_AVATAR = tgUser.photo_url || "";

      // üîπ O'yinni boshlash
      function startgame() {
        let random1 = Math.floor(Math.random() * 10);
        let random2 = Math.floor(Math.random() * 10);
        const amal = Math.random() < 0.5 ? "+" : "-";

        if (amal === "-" && random1 < random2)
          [random1, random2] = [random2, random1];

        currentAnswer = amal === "+" ? random1 + random2 : random1 - random2;

        randomnum1.textContent = `${random1} ${amal} ${random2} = ?`;

        const variantlar = [
          currentAnswer,
          currentAnswer + Math.floor(Math.random() * 3) + 1,
          currentAnswer - Math.floor(Math.random() * 3) - 1,
        ].sort(() => Math.random() - 0.5);

        javoblar.forEach((el, i) => (el.textContent = variantlar[i]));
      }

      // üîπ Javobni tekshirish
      javoblar.forEach((el) => {
        el.addEventListener("click", () => {
          if (parseInt(el.textContent) === currentAnswer) {
            togri++;
            togrijavob.textContent = `‚úÖ ${togri}`;
          } else {
            xato++;
            xatolar.textContent = `‚ùå ${xato}`;
          }

          if (xato === 4) {
            alert(`O'yin tugadi! To'g'ri javoblar soni: ${togri}`);
            saveScore();
            togri = 0;
            xato = 0;
            togrijavob.textContent = `‚úÖ ${togri}`;
            xatolar.textContent = `‚ùå ${xato}`;
            return;
          }

          startgame();
          startProgress();
        });
      });

      function startgame() {
        // savol yaratish
        let random1 = Math.floor(Math.random() * 10);
        let random2 = Math.floor(Math.random() * 10);
        const amal = Math.random() < 0.5 ? "+" : "-";

        if (amal === "-" && random1 < random2)
          [random1, random2] = [random2, random1];

        currentAnswer = amal === "+" ? random1 + random2 : random1 - random2;
        randomnum1.textContent = `${random1} ${amal} ${random2} = ?`;

        const variantlar = [
          currentAnswer,
          currentAnswer + Math.floor(Math.random() * 3) + 1,
          currentAnswer - Math.floor(Math.random() * 3) - 1,
        ].sort(() => Math.random() - 0.5);

        javoblar.forEach((el, i) => (el.textContent = variantlar[i]));
      }

      let timer; // global

      function startProgress() {
        const bar = document.querySelector(".time");
        clearTimeout(timer); // <--- eski timeout‚Äôni tozalash

        bar.style.transition = "none";
        bar.style.width = "100%";

        setTimeout(() => {
          bar.style.transition = "width 5s linear";
          bar.style.width = "0%";
        }, 50);
        if (xato === 4) {
          alert(`O'yin tugadi! To'g'ri javoblar soni: ${togri}`);
          saveScore();
          togri = 0;
          xato = 0;
          togrijavob.textContent = `‚úÖ ${togri}`;
          xatolar.textContent = `‚ùå ${xato}`;
          return;
        }
        timer = setTimeout(() => {
          xato++;
          xatolar.textContent = `‚ùå ${xato}`;
          startgame();
          startProgress();
        }, 5000);
      }

      // üîπ Boshlash tugmasi
      function boshlash() {
        document.getElementById("game-container").style.display = "block";
        document.getElementById("menyu").style.display = "none";
        startgame();
        startProgress();
      }

      // üîπ Statistika tugmasi
      function statistika() {
        document.querySelector(".statistika-container").style.display = "block";
        document.getElementById("menyu").style.display = "none";
        getRanking();
      }

      // üîπ Score‚Äôni serverga yuborish
      function saveScore() {
        if (!TELEGRAM_USER_ID) return;

        fetch("https://matematika.onrender.com/save-score", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            user_id: TELEGRAM_USER_ID,
            score: togri,
            name: TELEGRAM_USER_NAME,
            avatar: TELEGRAM_USER_AVATAR,
          }),
        }).catch((err) => console.log(err));
      }

      // üîπ Reytingni olish va ko'rsatish
      function getRanking() {
        fetch("https://matematika.onrender.com/get-ranking")
          .then((res) => res.json())
          .then((data) => {
            const rankingList = document.getElementById("ranking-list");
            rankingList.innerHTML = "";

            let userRank = null; // foydalanuvchining o‚Äòrni
            let totalUsers = data.length; // umumiy foydalanuvchi soni

            data.forEach((user, i) => {
              const li = document.createElement("li");
              const img = user.avatar
                ? `<img src="${user.avatar}" alt="avatar" style="width:30px;height:30px;border-radius:50%;margin-right:5px;">`
                : "";
              const username = user.username ? `(@${user.username})` : "";
              li.innerHTML = `${i + 1}. ${img} <b>${
                user.name
              }</b> ${username} ‚Äî ${user.score} ‚úÖ`;
              rankingList.appendChild(li);

              // agar foydalanuvchi aynan shu bo‚Äòlsa, rankni saqlab qo‚Äòyamiz
              if (user.user_id === TELEGRAM_USER_ID) {
                userRank = i + 1;
              }
            });

            // üîπ Foydalanuvchi o‚Äòz o‚Äòrnini yuqorida ko‚Äòrishi uchun
            const userStat = document.createElement("div");
            userStat.style.marginTop = "15px";
            userStat.style.fontWeight = "bold";

            if (userRank) {
              userStat.innerHTML = `‚≠ê Sizning o‚Äòrningiz: ${userRank}-o‚Äòrin / ${totalUsers} ta foydalanuvchi orasida`;
            } else {
              userStat.innerHTML = `Siz hali reytingda yo‚Äòqsiz üò¢ O‚Äòyin o‚Äòynab ko‚Äòproq ball to‚Äòplang!`;
            }

            rankingList.parentElement.appendChild(userStat);
          })
          .catch((err) => console.log(err));
      }
    </script>
  </body>
</html>
