<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <title>Matematik</title>
  </head>
  <body>
    <!-- ğŸ”¹ Asosiy menyu -->
    <div id="menyu" class="menyu">
      <button onclick="showLevels()">â–¶ï¸ Boshlash</button>
      <button onclick="statistika()">ğŸ“Š Statistika</button>
    </div>

    <!-- ğŸ”¹ O'yin oynasi -->
    <div id="game-container" class="game-container" style="display: none">
      <div class="container">
        <div class="control-container">
          <div class="togrijavob">âœ… 0</div>
          <div class="xatolar">âŒ 0</div>
        </div>

        <div class="game-bar">
          <div class="randomnumber">
            <span id="randomnum1"></span>
          </div>

          <div class="variantlar">
            <span class="javob"></span>
            <span class="javob"></span>
            <span class="javob"></span>
          </div>

          <div class="game-end" style="display: none">
            <p>O'yin tugadi!</p>
            <button
              class="qaytaBoshlash"
              onclick="qaytaBoshlash()"
              style="display: none"
            >
              Qayta boshlash
            </button>
          </div>

          <div class="time-container">
            <div class="time"></div>
          </div>
        </div>

        <button class="Orqaga" onclick="backToMenu()">ğŸ”™ Orqaga</button>
      </div>
    </div>

    <!-- ğŸ”¹ Statistika oynasi -->
    <div class="statistika-container" style="display: none">
      <h2>Statistika</h2>
      <div class="user-statistik">
        <h3>Top foydalanuvchilar:</h3>
        <div class="daraja-boyicha">
          <button onclick="statistika(1)">1-daraja</button>
          <button onclick="statistika(2)">2-daraja</button>
          <button onclick="statistika(3)">3-daraja</button>
        </div>
        <ul id="ranking-list"></ul>
      </div>
      <button class="Orqaga" onclick="backToMenu()">ğŸ”™ Orqaga</button>
    </div>

    <!-- ğŸ”¹ Darajalar oynasi -->
    <div id="darajalar" class="darajalar" style="display: none">
      <div class="daraja-1">
        <h2>1-daraja: Qoâ€˜shish va ayirish</h2>
        <p>1 dan 10 gacha sonlar bilan ishlang.</p>
        <button onclick="startLevel(1)">Boshlash</button>
      </div>
      <div class="daraja-2">
        <h2>2-daraja: Koâ€˜paytirish va boâ€˜lish</h2>
        <p>Bu bosqichda siz Ã— va Ã· amallarini bajarasiz.</p>
        <button onclick="startLevel(2)">Boshlash</button>
      </div>
      <div class="daraja-3">
        <h2>3-daraja: Aralash amallar</h2>
        <p>Qoâ€˜shish, ayirish, koâ€˜paytirish, boâ€˜lish aralash boâ€˜ladi.</p>
        <button onclick="startLevel(3)">Boshlash</button>
      </div>
      <button class="Orqaga" onclick="backToMenu()">ğŸ”™ Orqaga</button>
    </div>

    <script>
      // ================================
      // ğŸ”¹ Global oâ€˜zgaruvchilar
      // ================================
      const randomnum1 = document.getElementById("randomnum1");
      const javoblar = document.querySelectorAll(".javob");
      const togrijavob = document.querySelector(".togrijavob");
      const xatolar = document.querySelector(".xatolar");
      let togri = 0;
      let xato = 0;
      let currentAnswer = null;
      let timer;
      let currentLevel = 1;

      const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user || {};
      const TELEGRAM_USER_ID = tgUser.id || 0;
      const TELEGRAM_USER_NAME = `${tgUser.first_name || ""} ${
        tgUser.last_name || ""
      }`.trim();
      const TELEGRAM_USER_AVATAR = tgUser.photo_url || "";

      // ================================
      // ğŸ”¹ Menyular
      // ================================
      function showLevels() {
        document.getElementById("menyu").style.display = "none";
        document.getElementById("darajalar").style.display = "flex";
      }

      function backToMenu() {
        document.getElementById("menyu").style.display = "flex";
        document.getElementById("game-container").style.display = "none";
        document.getElementById("darajalar").style.display = "none";
        document.querySelector(".statistika-container").style.display = "none";
      }

      // ================================
      // ğŸ”¹ O'yinni boshlash
      // ================================
      function startLevel(level) {
        currentLevel = level;
        document.getElementById("game-container").style.display = "block";
        document.getElementById("darajalar").style.display = "none";

        togri = 0;
        xato = 0;
        togrijavob.textContent = `âœ… ${togri}`;
        xatolar.textContent = `âŒ ${xato}`;

        javoblar.forEach((el) => (el.style.pointerEvents = "auto"));
        document.querySelector(".time").style.display = "block";

        startgame();
        startProgress();
      }

      function startgame() {
        let random1 = Math.floor(Math.random() * 10) + 1;
        let random2 = Math.floor(Math.random() * 10) + 1;
        let amal;

        if (currentLevel === 1) amal = Math.random() < 0.5 ? "+" : "-";
        else if (currentLevel === 2) amal = Math.random() < 0.5 ? "Ã—" : "Ã·";
        else {
          const amallar = ["+", "-", "Ã—", "Ã·"];
          amal = amallar[Math.floor(Math.random() * amallar.length)];
        }

        if (amal === "-") {
          if (random1 < random2) [random1, random2] = [random2, random1];
          currentAnswer = random1 - random2;
        } else if (amal === "+") currentAnswer = random1 + random2;
        else if (amal === "Ã—") currentAnswer = random1 * random2;
        else {
          random1 = random1 * random2;
          currentAnswer = random1 / random2;
        }

        randomnum1.textContent = `${random1} ${amal} ${random2} = ?`;

        const variantlar = [
          currentAnswer,
          currentAnswer + Math.floor(Math.random() * 3) + 1,
          currentAnswer - Math.floor(Math.random() * 3) - 1,
        ].sort(() => Math.random() - 0.5);

        javoblar.forEach((el, i) => (el.textContent = variantlar[i]));
      }

      javoblar.forEach((el) => {
        el.addEventListener("click", () => {
          if (parseFloat(el.textContent) === currentAnswer) {
            togri++;
            togrijavob.textContent = `âœ… ${togri}`;
          } else {
            xato++;
            xatolar.textContent = `âŒ ${xato}`;
          }

          if (xato === 4) {
            gameOver();
            return;
          }

          startgame();
          startProgress();
        });
      });

      function startProgress() {
        const bar = document.querySelector(".time");
        clearTimeout(timer);
        bar.style.transition = "none";
        bar.style.width = "100%";

        setTimeout(() => {
          bar.style.transition = "width 5s linear";
          bar.style.width = "0%";
        }, 50);

        timer = setTimeout(() => {
          xato++;
          xatolar.textContent = `âŒ ${xato}`;
          if (xato === 4) gameOver();
          else {
            startgame();
            startProgress();
          }
        }, 5000);
      }

      async function gameOver() {
        clearTimeout(timer);
        timer = null;

        document.querySelector(".game-end").style.display = "flex";
        document.querySelector(".qaytaBoshlash").style.display = "block";
        javoblar.forEach((el) => (el.style.pointerEvents = "none"));
        document.querySelector(".time").style.display = "none";

        if (TELEGRAM_USER_ID) {
          try {
            await fetch("https://matematika.onrender.com/save-score", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                user_id: TELEGRAM_USER_ID,
                score: togri,
                name: TELEGRAM_USER_NAME,
                avatar: TELEGRAM_USER_AVATAR,
                level: currentLevel,
              }),
            });
          } catch (e) {
            console.error("âŒ Saqlash xatosi:", e);
          }
        }
      }

      function qaytaBoshlash() {
        togri = 0;
        xato = 0;
        togrijavob.textContent = `âœ… ${togri}`;
        xatolar.textContent = `âŒ ${xato}`;
        document.querySelector(".qaytaBoshlash").style.display = "none";
        document.querySelector(".game-end").style.display = "none";
        document.querySelector(".time").style.display = "block";
        javoblar.forEach((el) => (el.style.pointerEvents = "auto"));
        startgame();
        startProgress();
      }

      // ================================
      // ğŸ”¹ Statistika oynasi
      // ================================
      async function statistika(level = 1) {
        document.getElementById("menyu").style.display = "none";
        document.querySelector(".statistika-container").style.display = "block";
        await getRanking(level);
      }

      async function getRanking(level = 1) {
        const rankingList = document.getElementById("ranking-list");
        rankingList.innerHTML = "<p>Yuklanmoqda...</p>";

        try {
          const res = await fetch(
            `https://matematika.onrender.com/get-ranking?level=${level}`
          );
          const data = await res.json();
          rankingList.innerHTML = "";

          if (!data || data.length === 0) {
            rankingList.innerHTML = `<p>âŒ ${level}-darajada foydalanuvchi yoâ€˜q</p>`;
            return;
          }

          data.forEach((user, i) => {
            if (!user.scores || user.scores[level] === undefined) return;

            const li = document.createElement("li");
            li.style.display = "flex";
            li.style.alignItems = "center";
            li.style.marginBottom = "5px";

            const img = document.createElement("img");
            img.src = user.avatar || "";
            img.alt = "avatar";
            img.style.width = "45px";
            img.style.height = "45px";
            img.style.borderRadius = "50%";
            img.style.marginRight = "10px";
            if (!user.avatar) img.style.display = "none";

            const rank = ["ğŸ¥‡", "ğŸ¥ˆ", "ğŸ¥‰"][i] || i + 1;
            const reytingNum = document.createElement("span");
            reytingNum.classList.add("reytingnum");
            reytingNum.textContent = rank;

            const nameSpan = document.createElement("span");
            nameSpan.innerHTML = `<b>${user.name || "NoName"}</b>`;

            const scoreSpan = document.createElement("span");
            scoreSpan.style.marginLeft = "auto";
            scoreSpan.textContent = `${user.scores[level]} âœ…`;

            li.append(reytingNum, img, nameSpan, scoreSpan);
            rankingList.appendChild(li);
          });
        } catch {
          rankingList.innerHTML = `<p>âŒ ${level}-darajada foydalanuvchi yoâ€˜q</p>`;
        }
      }
    </script>
  </body>
</html>
