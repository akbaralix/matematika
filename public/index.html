<!DOCTYPE html>
<html lang="uz">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <title>Matematik</title>
  </head>
  <body>
    <!-- ğŸ”¹ Asosiy menyu -->
    <div id="menyu" class="menyu">
      <button onclick="boshlash()">â–¶ï¸ Boshlash</button>
      <button onclick="statistika()">ğŸ“Š Statistika</button>
    </div>

    <!-- ğŸ”¹ O'yin container -->
    <div id="game-container" class="game-container" style="display: none">
      <div class="container">
        <div class="control-container">
          <div class="togrijavob">âœ… 0</div>
          <div class="xatolar">âŒ 0</div>
        </div>

        <div class="game-bar">
          <div class="randomnumber">
            <span id="randomnum1"></span>
          </div>
          <div class="variantlar">
            <span class="javob"></span>
            <span class="javob"></span>
            <span class="javob"></span>
          </div>

          <div class="game-end" style="display: none">
            <button
              class="qaytaBoshlash"
              onclick="qaytaBoshlash()"
              style="display: none"
            >
              Qayta boshlash
            </button>
            <p>O'yin tugadi!</p>
          </div>

          <div class="time-container">
            <div class="time"></div>
          </div>
        </div>

        <button class="Orqaga" onclick="window.location.href = 'index.html'">
      </div>
    </div>

    <!-- ğŸ”¹ Statistika container -->
    <div class="statistika-container" style="display: none">
      <h2>Statistika</h2>
      <div class="user-statistik">
        <h3>Top foydalanuvchilar:</h3>
        <div id="ranking-list"></div>
      </div>
      <button class="Orqaga" onclick="window.location.href = 'index.html'">
        ğŸ”™ Orqaga
      </button>
    </div>

    <script>
      // ğŸ”¹ Elementlar
      const randomnum1 = document.getElementById("randomnum1");
      const javoblar = document.querySelectorAll(".javob");
      const togrijavob = document.querySelector(".togrijavob");
      const xatolar = document.querySelector(".xatolar");
      let togri = 0;
      let xato = 0;
      let currentAnswer = null;
      let timer;

      // ğŸ”¹ Telegram WebApp foydalanuvchi ma'lumotlari
      const tgUser = window.Telegram?.WebApp?.initDataUnsafe?.user || {};
      const TELEGRAM_USER_ID = tgUser.id || 0;
      const TELEGRAM_USER_NAME = `${tgUser.first_name || ""} ${
        tgUser.last_name || ""
      }`.trim();
      const TELEGRAM_USER_AVATAR = tgUser.photo_url || "";

      // ğŸ”¹ Javobni tekshirish
      javoblar.forEach((el) => {
        el.addEventListener("click", () => {
          if (parseInt(el.textContent) === currentAnswer) {
            togri++;
            togrijavob.textContent = `âœ… ${togri}`;
          } else {
            xato++;
            xatolar.textContent = `âŒ ${xato}`;
          }

          if (xato === 4) {
            gameOver();
            return;
          }

          startgame();
          startProgress();
        });
      });

      // ğŸ”¹ O'yin tugadi
      // ...existing code...
      async function gameOver() {
        clearTimeout(timer);
        timer = null;

        // ballni serverga yuborish
        if (TELEGRAM_USER_ID) {
          try {
            const response = await fetch(
              "https://matematika.onrender.com/save-score",
              {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  Accept: "application/json",
                },
                body: JSON.stringify({
                  user_id: TELEGRAM_USER_ID,
                  score: togri,
                  name: TELEGRAM_USER_NAME,
                  avatar: TELEGRAM_USER_AVATAR,
                }),
              }
            );

            if (!response.ok) {
              throw new Error(
                `Server responded with status: ${response.status}`
              );
            }

            const result = await response.json();
            alert("âœ… Ball muvaffaqiyatli saqlandi:", result);
          } catch (err) {
            alert("âŒ Ball saqlashda xatolik:", err);
          }
        } else {
          alert("âš ï¸ Telegram foydalanuvchi ID topilmadi");
        }

        document.querySelector(".qaytaBoshlash").style.display = "block";
        document.querySelector(".game-end").style.display = "flex";
        const javob = document.querySelectorAll(".javob");
        javob.forEach((el) => (el.style.pointerEvents = "none"));
        const bar = document.querySelector(".time");
        bar.style.display = "none";
      }
      // ...existing code...
      // ğŸ”¹ Qayta boshlash tugmasi
      function qaytaBoshlash() {
        togri = 0;
        xato = 0;
        togrijavob.textContent = `âœ… ${togri}`;
        xatolar.textContent = `âŒ ${xato}`;
        document.querySelector(".qaytaBoshlash").style.display = "none";
        document.querySelector(".game-end").style.display = "none";
        document.querySelector(".time").style.display = "block";
        const javob = document.querySelectorAll(".javob");
        javob.forEach((el) => (el.style.pointerEvents = "auto"));

        // timerni qayta ishga tushirish
        timer = 0;
        startgame();
        startProgress();
      }

      // ğŸ”¹ Savol yaratish
      function startgame() {
        let random1 = Math.floor(Math.random() * 10);
        let random2 = Math.floor(Math.random() * 10);
        const amal = Math.random() < 0.5 ? "+" : "-";

        if (amal === "-" && random1 < random2)
          [random1, random2] = [random2, random1];

        currentAnswer = amal === "+" ? random1 + random2 : random1 - random2;
        randomnum1.textContent = `${random1} ${amal} ${random2} = ?`;

        const variantlar = [
          currentAnswer,
          currentAnswer + Math.floor(Math.random() * 3) + 1,
          currentAnswer - Math.floor(Math.random() * 3) - 1,
        ].sort(() => Math.random() - 0.5);

        javoblar.forEach((el, i) => (el.textContent = variantlar[i]));
      }

      // ğŸ”¹ Progress bar va vaqt
      function startProgress() {
        const bar = document.querySelector(".time");

        // agar gameOver bo'lsa timer ishlamasin
        if (timer === null) return;

        clearTimeout(timer);
        bar.style.transition = "none";
        bar.style.width = "100%";

        setTimeout(() => {
          bar.style.transition = "width 5s linear";
          bar.style.width = "0%";
        }, 50);

        timer = setTimeout(() => {
          xato++;
          xatolar.textContent = `âŒ ${xato}`;

          if (xato === 4) {
            gameOver();
            return;
          }

          startgame();
          startProgress();
        }, 5000);
      }

      // ğŸ”¹ Boshlash tugmasi
      function boshlash() {
        document.getElementById("game-container").style.display = "block";
        document.getElementById("menyu").style.display = "none";
        startgame();
        startProgress();
      }

      // ğŸ”¹ Statistika tugmasi
      async function statistika() {
        document.getElementById("menyu").style.display = "none";
        document.querySelector(".statistika-container").style.display = "block";
        await getRanking();
      }

      // ğŸ”¹ Reytingni olish
      async function getRanking() {
        const rankingList = document.getElementById("ranking-list");
        rankingList.innerHTML = "<p>Yuklanmoqda...</p>";

        try {
          const res = await fetch(
            "https://matematika.onrender.com/get-ranking"
          );
          const data = await res.json();

          rankingList.innerHTML = "";
          let userRank = null;
          const totalUsers = data.length;

          data.forEach((user, i) => {
            if (!user.score || user.score === 0) return;
            const li = document.createElement("li");
            li.style.display = "flex";
            li.style.alignItems = "center";
            li.style.marginBottom = "5px";

            // avatar
            const img = document.createElement("img");
            img.src = user.avatar || "";
            img.alt = "avatar";
            img.style.width = "45px";
            img.style.height = "45px";
            img.style.borderRadius = "50%";
            img.style.marginRight = "10px";
            if (!user.avatar) img.style.display = "none";

            const reytingNum = document.createElement("span");
            reytingNum.classList.add("reytingnum");
            reytingNum.innerHTML = `${i + 1}`;
            
            if (reytingNum.textContent === "1") {
  reytingNum.textContent = "ğŸ¥‡";
} else if (reytingNum.textContent === "2") {
  reytingNum.textContent = "ğŸ¥ˆ";
} else if (reytingNum.textContent === "3") {
  reytingNum.textContent = "ğŸ¥‰";
}

            // foydalanuvchi ismi va username
            const nameSpan = document.createElement("span");
            nameSpan.classList.add("username");
            nameSpan.innerHTML = ` <b>${user.name || "NoName"}</b>

            `;

            // score
            const scoreSpan = document.createElement("span");
            scoreSpan.style.marginLeft = "auto";
            scoreSpan.textContent = `${user.score ?? 0} âœ…`;

            li.appendChild(reytingNum);
            li.appendChild(img);
            li.appendChild(nameSpan);
            li.appendChild(scoreSpan);

            rankingList.appendChild(li);

            if (user.user_id === TELEGRAM_USER_ID) userRank = i + 1;
          });

          // foydalanuvchi oâ€˜rnini koâ€˜rsatish
          const userStat = document.createElement("div");
          userStat.style.marginTop = "15px";
          userStat.style.fontWeight = "bold";

          rankingList.parentElement.appendChild(userStat);
        } catch (err) {
          rankingList.innerHTML =
            "<p>âŒ Reytingni olishda xatolik yuz berdi.</p>";
          console.log(err);
        }
      }
    </script>
  </body>
</html>
